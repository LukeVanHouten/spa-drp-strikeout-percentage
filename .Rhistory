View(k_df)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
Head(platoon_s_df)
head(platoon_s_df)
strike_percentage <- platoon_s_df %>%
filter(type %in% c("S", "X")) %>%
group_by(pitcher, game_year) %>%
summarize(strike_percentage = n() / n_distinct(id)) %>%
mutate(strike_percentage = ifelse(is.na(strike_percentage), 0, strike_percentage))
platoon_advantage <- platoon_s_df %>%
group_by(pitcher, game_year, stand, p_throws) %>%
summarize(platoon_count = sum(stand == p_throws)) %>%
mutate(total_count = n()) %>%
mutate(platoon_advantage = ifelse(total_count == 0, 0, platoon_count / total_count))
platoon_s_result <- left_join(strike_percentage, platoon_advantage, by = c("pitcher", "game_year"))
View(platoon_s_result)
strike_percentage <- platoon_s_df %>%
filter(type %in% c("S", "X")) %>%
group_by(pitcher, game_year) %>%
summarize(strike_percentage = n() / n_distinct(.data$id),
.groups = "drop_last") %>%
mutate(strike_percentage = ifelse(is.na(strike_percentage), 0, strike_percentage))
platoon_advantage <- platoon_s_df %>%
group_by(pitcher, game_year, stand, p_throws) %>%
summarize(platoon_count = sum(stand == p_throws)) %>%
mutate(total_count = n()) %>%
mutate(platoon_advantage = ifelse(total_count == 0, 0, platoon_count / total_count))
platoon_s_result <- left_join(strike_percentage, platoon_advantage, by = c("pitcher", "game_year"))
View(platoon_s_result)
strike_percentage <- platoon_s_df %>%
filter(type %in% c("S", "X")) %>%
group_by(pitcher, game_year) %>%
summarize(strike_percentage = n() / n_distinct(.platoon_s_df$id),
.groups = "drop_last") %>%
mutate(strike_percentage = ifelse(is.na(strike_percentage), 0, strike_percentage))
platoon_advantage <- platoon_s_df %>%
group_by(pitcher, game_year, stand, p_throws) %>%
summarize(platoon_count = sum(stand == p_throws)) %>%
mutate(total_count = n()) %>%
mutate(platoon_advantage = ifelse(total_count == 0, 0, platoon_count / total_count))
platoon_s_result <- left_join(strike_percentage, platoon_advantage, by = c("pitcher", "game_year"))
View(platoon_s_result)
strike_percentage <- platoon_s_df %>%
filter(type %in% c("S", "X")) %>%
group_by(pitcher, game_year) %>%
summarize(strike_percentage = n() / n_distinct(id),
.groups = "drop_last") %>%
mutate(strike_percentage = ifelse(is.na(strike_percentage), 0, strike_percentage))
platoon_advantage <- platoon_s_df %>%
group_by(pitcher, game_year, stand, p_throws) %>%
summarize(platoon_count = sum(stand == p_throws),
total_count = n()) %>%
mutate(platoon_advantage = ifelse(total_count == 0, 0, platoon_count / total_count),
.groups = "drop_last")
platoon_s_result <- left_join(strike_percentage, platoon_advantage, by = c("pitcher", "game_year"))
platoon_s_df <- platoon_s_df %>%
mutate(row_id = row_number())
strike_percentage <- platoon_s_df %>%
filter(type %in% c("S", "X")) %>%
group_by(pitcher, game_year) %>%
summarize(strike_percentage = n() / n_distinct(row_id),
.groups = "drop_last") %>%
mutate(strike_percentage = ifelse(is.na(strike_percentage), 0, strike_percentage))
platoon_advantage <- platoon_s_df %>%
group_by(pitcher, game_year, stand, p_throws) %>%
summarize(platoon_count = sum(stand == p_throws),
total_count = n()) %>%
mutate(platoon_advantage = ifelse(total_count == 0, 0, platoon_count / total_count),
.groups = "drop_last")
result <- left_join(strike_percentage, platoon_advantage, by = c("pitcher", "game_year"))
View(result)
head(result)
strike_percentage <- platoon_s_df %>%
filter(type %in% c("S", "X")) %>%
group_by(pitcher, game_year) %>%
summarize(strike_percentage = sum(type %in% c("S", "X")) / n(),
.groups = "drop_last") %>%
mutate(strike_percentage = ifelse(is.na(strike_percentage), 0, strike_percentage))
View(strike_percentage)
platoon_s_df <- dbGetQuery(conn, platoon_s_query)
platoon_s_df %>%
group_by(pitcher, game_year) %>%
summarize(strike_percentage = sum(type != "B") / n())
View(platoon_s_df)
platoon_s_df <- platoon_s_df %>%
group_by(pitcher, game_year) %>%
summarize(strike_percentage = sum(type != "B") / n())
View(platoon_s_df)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
head(platoon_df)
View(platoon_s_k_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number)
View(strikeout_df)
head(platoon_df)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
head(platoon_df)
platoon_df <- platoon_s_k_df %>%
select(pitcher, game_year, stand, p_throws) %>%
group_by(pitcher, game_year) %>%
summarize(platoon_advantage = sum(stand == p_throws) / n())
View(platoon_df)
head(strikeout_data)
head(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
group_by(pitcher, game_year) %>%
summarize(strikeout_percentage = mean(strikeouts / n_distinct(game_date)))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
group_by(pitcher, game_year) %>%
summarize(strikeout_percentage = mean(strikeouts / n_distinct(game_date)))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
group_by(pitcher, game_year) %>%
summarize(strikeout_percentage = mean(strikeouts / 771))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
group_by(pitcher, game_year) %>%
summarize(strikeout_percentage = mean(136 / n_distinct(game_date)))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
# group_by(pitcher, game_year) %>%
# summarize(strikeout_percentage = mean(strikeouts / n_distinct(game_date)))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout"))
# group_by(pitcher, game_year) %>%
# summarize(strikeout_percentage = mean(strikeouts / n_distinct(game_date)))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout"))
group_by(pitcher, game_year, game_date) %>%
summarize(strikeouts_game = sum(strikeouts))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
group_by(pitcher, game_year, game_date) %>%
summarize(strikeouts_game = sum(strikeouts))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
group_by(pitcher, game_year, game_date) %>%
summarize(strikeouts_game = sum(strikeouts), at_bats_game = count(at_bat_number))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
group_by(pitcher, game_year, game_date) %>%
summarize(strikeouts_game = sum(strikeouts), at_bats_game = n_distinct(at_bat_number))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
# group_by(pitcher, game_year, game_date) %>%
summarize(strikeouts_game = sum(strikeouts), at_bats_game = n_distinct(at_bat_number))
View(strikeout_df)
strikeout_df <- platoon_s_k_df %>%
select(game_date, pitcher, events, game_year, at_bat_number) %>%
filter(events != "") %>%
group_by(pitcher, game_year, game_date, at_bat_number) %>%
summarize(strikeouts = sum(events == "strikeout")) %>%
summarize(strikeouts_game = sum(strikeouts), at_bats_game = n_distinct(at_bat_number)) %>%
group_by(pitcher, game_year) %>%
summarize(strikeout_percentage = sum(strikeouts_game) / sum(at_bats_game))
View(strikeout_df)
result <- merge(merge(strike_df, platoon_df, by = c("pitcher", "game_year"), all.x = TRUE),
strikeout_df, by = c("pitcher", "game_year"), all.x = TRUE)
random_forest_df <- merge(result, sql_df, by = c("pitcher", "game_year"), all.x = TRUE)
View(random_forest_df)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
View(joined_df)
install.packages(shapr)
install.packages("shapr"")
install.packages("shapr")
library(shapr)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
model <- xgboost(
data = df_train_features,
label = df_train_labels,
nround = 20,
verbose = FALSE
)
model <- xgboost(
data = data.matrix(df_train_features),
label = data.matrix(df_train_labels),
nround = 20,
verbose = FALSE
)
train_features <- data.matrix(df_train_features)
train_labels <- data.matrix(df_train_labels)
test_features <- data.matrix(df_test_features)
test_labels <- data.matrix(df_test_labels)
model <- xgboost(
data = train_features,
label = train_labels,
nround = 20,
verbose = FALSE
)
explainer <- shapr(train_features, model)
df_train_features <- joined_df %>%
subset(game_year != 2021) %>%
select(strike_percentage, platoon_advantage, velo_max, velo_range,
velo_iqr, vertical_movement_max, vertical_movement_range,
vertical_movement_iqr, horizontal_movement_max,
horizontal_movement_range, horizontal_movement_iqr,
release_spin_rate_max, release_spin_rate_iqr)
df_train_labels <- joined_df %>%
subset(game_year != 2021) %>%
select(strikeout_percentage)
df_test_features <- joined_df %>%
subset(game_year == 2021) %>%
select(strike_percentage, platoon_advantage, velo_max, velo_range,
velo_iqr, vertical_movement_max, vertical_movement_range,
vertical_movement_iqr, horizontal_movement_max,
horizontal_movement_range, horizontal_movement_iqr,
release_spin_rate_max, release_spin_rate_iqr)
df_test_labels <- joined_df %>%
subset(game_year == 2021) %>%
select(strikeout_percentage)
train_features <- data.matrix(df_train_features)
train_labels <- data.matrix(df_train_labels)
test_features <- data.matrix(df_test_features)
test_labels <- data.matrix(df_test_labels)
model <- xgboost(
data = train_features,
label = train_labels,
nround = 20,
verbose = FALSE
)
explainer <- shapr(train_features, model)
p <- mean(train_labels)
explanation <- explain(
test_features,
approach = "empirical",
explainer = explainer,
prediction_zero = p
)
plot(explanation, plot_phi0 = FALSE, index_x_test = c(1, 6))
df_train_features <- joined_df %>%
subset(game_year != 2021) %>%
select(strike_percentage, platoon_advantage, velo_max, velo_iqr,
vertical_movement_max, vertical_movement_iqr,
horizontal_movement_max, horizontal_movement_iqr)
df_train_labels <- joined_df %>%
subset(game_year != 2021) %>%
select(strikeout_percentage)
df_test_features <- joined_df %>%
subset(game_year == 2021) %>%
select(strike_percentage, platoon_advantage, velo_max, velo_iqr,
vertical_movement_max, vertical_movement_iqr,
horizontal_movement_max, horizontal_movement_iqr)
df_test_labels <- joined_df %>%
subset(game_year == 2021) %>%
select(strikeout_percentage)
train_features <- data.matrix(df_train_features)
train_labels <- data.matrix(df_train_labels)
test_features <- data.matrix(df_test_features)
test_labels <- data.matrix(df_test_labels)
model <- xgboost(
data = train_features,
label = train_labels,
nround = 20,
verbose = FALSE
)
explainer <- shapr(train_features, model)
p <- mean(train_labels)
explanation <- explain(
test_features,
approach = "empirical",
explainer = explainer,
prediction_zero = p
)
plot(explanation, plot_phi0 = FALSE, index_x_test = c(1, 6))
View(model)
print(model)
View(explainer)
print(explainer)
strike_platoon_df <- platoon_s_k_df %>%
select(pitcher, game_year, stand, p_throws, type) %>%
group_by(pitcher, game_year) %>%
summarize(platoon_advantage = sum(stand == p_throws) / n())
summarize(strike_percentage = sum(type != "B") / n())
View(strike_platoon_df)
platoon_s_k_df <- dbGetQuery(conn, platoon_s_k_query)
strike_platoon_df <- platoon_s_k_df %>%
select(pitcher, game_year, stand, p_throws, type) %>%
group_by(pitcher, game_year) %>%
summarize(platoon_advantage = sum(stand == p_throws) / n())
summarize(strike_percentage = sum(type != "B") / n())
View(strike_platoon_df)
strike_platoon_df <- platoon_s_k_df %>%
select(pitcher, game_year, stand, p_throws, type) %>%
group_by(pitcher, game_year) %>%
summarize(platoon_advantage = sum(stand == p_throws) / n(),
strike_percentage = sum(type != "B") / n())
View(strike_platoon_df)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
print(train_features[!complete.cases(train_features), ])
df_train_features <- joined_df %>%
subset(game_year != 2021) %>%
select(strike_percentage, platoon_advantage, velo_max, velo_iqr,
vertical_movement_max, vertical_movement_iqr,
horizontal_movement_max, horizontal_movement_iqr) %>%
na.omit()
df_train_features <- joined_df %>%
subset(game_year != 2021) %>%
select(strike_percentage, platoon_advantage, velo_max, velo_iqr,
vertical_movement_max, vertical_movement_iqr,
horizontal_movement_max, horizontal_movement_iqr) %>%
na.omit()
df_train_labels <- joined_df %>%
subset(game_year != 2021) %>%
select(strikeout_percentage) %>%
na.omit()
df_test_features <- joined_df %>%
subset(game_year == 2021) %>%
select(strike_percentage, platoon_advantage, velo_max, velo_iqr,
vertical_movement_max, vertical_movement_iqr,
horizontal_movement_max, horizontal_movement_iqr) %>%
na.omit()
df_test_labels <- joined_df %>%
subset(game_year == 2021) %>%
select(strikeout_percentage) %>%
na.omit()
train_features <- data.matrix(df_train_features)
train_labels <- data.matrix(df_train_labels)
test_features <- data.matrix(df_test_features)
test_labels <- data.matrix(df_test_labels)
model <- xgboost(
data = train_features,
label = train_labels,
nround = 20,
verbose = FALSE
)
explainer <- shapr(train_features, model)
p <- mean(train_labels)
explainer <- shapr(train_features, model)
p <- mean(train_labels)
model <- xgboost(
data = na.omit(train_features),
label = na.omit(train_features),
nround = 20,
verbose = FALSE
)
explainer <- shapr(train_features, model)
p <- mean(train_labels)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
explanation <- explain(
test_features,
approach = "empirical",
explainer = explainer,
prediction_zero = p
)
View(df_train_features)
View(sql_platoon_s_k_df)
source("C:/Users/lukev/baseball_drp/week6.R", echo=TRUE)
df_train_features <- joined_df %>%
subset(game_year != 2021) %>%
select(-pitcher, -game_year, -name)
df_train_labels <- joined_df %>%
subset(game_year != 2021) %>%
select(strikeout_percentage)
df_test_features <- joined_df %>%
subset(game_year == 2021) %>%
select(-pitcher, -game_year, -name)
df_test_labels <- joined_df %>%
subset(game_year == 2021) %>%
select(strikeout_percentage)
train_features <- data.matrix(df_train_features)
train_labels <- data.matrix(df_train_labels)
test_features <- data.matrix(df_test_features)
test_labels <- data.matrix(df_test_labels)
df_train_features <- joined_df %>%
subset(game_year != 2021) %>%
select(-pitcher, -game_year, -name, -strikeout_percentage)
df_train_labels <- joined_df %>%
subset(game_year != 2021) %>%
select(strikeout_percentage)
df_test_features <- joined_df %>%
subset(game_year == 2021) %>%
select(-pitcher, -game_year, -name, -strikeout_percentage)
df_test_labels <- joined_df %>%
subset(game_year == 2021) %>%
select(strikeout_percentage)
train_features <- data.matrix(df_train_features)
train_labels <- data.matrix(df_train_labels)
test_features <- data.matrix(df_test_features)
test_labels <- data.matrix(df_test_labels)
model <- xgboost(
data = train_features,
label = train_labels,
eta = 0.05,
max_depth = 0,
colsample_bytree = 0.8,
verbose = TRUE
)
model <- xgboost(
data = train_features,
label = train_labels,
eta = 0.05,
max_depth = 0,
nrounds = 20,
colsample_bytree = 0.8,
verbose = TRUE
)
model <- xgboost(
data = train_features,
label = train_labels,
eta = 0.05,
max_depth = 10,
nrounds = 20,
colsample_bytree = 0.8,
verbose = TRUE
)
print(model$feature_names)
plot(model$evaluation_log$iter, model$evaluation_log$train_rmse)
model <- xgboost(
data = train_features,
label = train_labels,
eta = 0.05,
max_depth = 10,
nrounds = 30,
colsample_bytree = 0.8,
verbose = TRUE
)
plot(model$evaluation_log$iter, model$evaluation_log$train_rmse)
model <- xgboost(
data = train_features,
label = train_labels,
eta = 0.05,
max_depth = 10,
nrounds = 40,
colsample_bytree = 0.8,
verbose = TRUE
)
plot(model$evaluation_log$iter, model$evaluation_log$train_rmse)
pred <- predict(model, test_features)
print(length(pred))
print(head(pred))
print(head(test_features))
print(head(test_labels))
print(head(test_features))
print(head(pred))
print(head(test_labels))
model <- xgboost(
data = train_features,
label = train_labels,
eta = 0.05,
max_depth = 10,
nrounds = 25,
colsample_bytree = 0.8,
verbose = TRUE
)
plot(model$evaluation_log$iter, model$evaluation_log$train_rmse)
pred <- predict(model, test_features)
print(head(pred))
print(head(test_labels))
model <- xgboost(
data = train_features,
label = train_labels,
eta = 0.05,
max_depth = 10,
nrounds = 100,
colsample_bytree = 0.8,
verbose = TRUE
)
plot(model$evaluation_log$iter, model$evaluation_log$train_rmse)
pred <- predict(model, test_features)
print(head(pred))
print(head(test_labels))
xgboost_mae <- mean(abs(pred - test_labels$strikeout_percentage))
print(xgboost_mae)
xgboost_mae <- mean(abs(pred - df_test_labels$strikeout_percentage))
print(xgboost_mae)
View(joined_df)
